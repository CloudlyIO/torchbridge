============================= test session starts ==============================
platform linux -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0 -- /opt/pytorch/bin/python3
cachedir: .pytest_cache
rootdir: /home/ubuntu
configfile: pytest.ini
plugins: anyio-4.12.1
collecting ... collected 71 items

tests/test_fp8_native.py::TestFP8Availability::test_is_fp8_available PASSED [  1%]
tests/test_fp8_native.py::TestFP8Availability::test_get_fp8_info PASSED  [  2%]
tests/test_fp8_native.py::TestFP8Availability::test_fp8_dtype_enum PASSED [  4%]
tests/test_fp8_native.py::TestFP8Availability::test_get_fp8_dtype PASSED [  5%]
tests/test_fp8_native.py::TestFP8Quantization::test_compute_fp8_scale_e4m3 PASSED [  7%]
tests/test_fp8_native.py::TestFP8Quantization::test_compute_fp8_scale_e5m2 PASSED [  8%]
tests/test_fp8_native.py::TestFP8Quantization::test_compute_fp8_scale_with_margin PASSED [  9%]
tests/test_fp8_native.py::TestFP8Quantization::test_quantize_to_fp8_e4m3 PASSED [ 11%]
tests/test_fp8_native.py::TestFP8Quantization::test_quantize_to_fp8_e5m2 PASSED [ 12%]
tests/test_fp8_native.py::TestFP8Quantization::test_dequantize_from_fp8 PASSED [ 14%]
tests/test_fp8_native.py::TestFP8Quantization::test_roundtrip_accuracy PASSED [ 15%]
tests/test_fp8_native.py::TestFP8Quantization::test_e4m3_vs_e5m2_precision PASSED [ 16%]
tests/test_fp8_native.py::TestFP8QuantizedTensor::test_from_tensor PASSED [ 18%]
tests/test_fp8_native.py::TestFP8QuantizedTensor::test_dequantize PASSED [ 19%]
tests/test_fp8_native.py::TestFP8QuantizedTensor::test_to_device PASSED  [ 21%]
tests/test_fp8_native.py::TestFP8QuantizedTensor::test_with_custom_scale PASSED [ 22%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_creation PASSED [ 23%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_creation_no_bias PASSED [ 25%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_forward PASSED [ 26%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_forward_batch PASSED [ 28%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_gradient_flow PASSED [ 29%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_weight_formats PASSED [ 30%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_get_fp8_info PASSED [ 32%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_sync_weights PASSED [ 33%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_training_mode PASSED [ 35%]
tests/test_fp8_native.py::TestNativeFP8Linear::test_layer_eval_mode PASSED [ 36%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_creation PASSED [ 38%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_prepare PASSED [ 39%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_infer PASSED [ 40%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_infer_not_prepared PASSED [ 42%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_memory_savings PASSED [ 43%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_layer_info PASSED [ 45%]
tests/test_fp8_native.py::TestFP8InferenceEngine::test_engine_with_calibration PASSED [ 46%]
tests/test_fp8_native.py::TestModelConversion::test_convert_model PASSED [ 47%]
tests/test_fp8_native.py::TestModelConversion::test_convert_model_inplace PASSED [ 49%]
tests/test_fp8_native.py::TestModelConversion::test_convert_model_not_inplace PASSED [ 50%]
tests/test_fp8_native.py::TestModelConversion::test_converted_model_forward PASSED [ 52%]
tests/test_fp8_native.py::TestModelConversion::test_converted_model_backward PASSED [ 53%]
tests/test_fp8_native.py::TestNumericalStability::test_large_values PASSED [ 54%]
tests/test_fp8_native.py::TestNumericalStability::test_small_values PASSED [ 56%]
tests/test_fp8_native.py::TestNumericalStability::test_mixed_range PASSED [ 57%]
tests/test_fp8_native.py::TestNumericalStability::test_fp8_linear_numerical_stability PASSED [ 59%]
tests/test_fp8_native.py::TestBenchmark::test_benchmark_fp8_layer PASSED [ 60%]
tests/test_fp8_native.py::TestIntegration::test_end_to_end_training PASSED [ 61%]
tests/test_fp8_native.py::TestIntegration::test_fp8_with_standard_layers PASSED [ 63%]
tests/test_fp8_native.py::test_quantization_formats[FP8Dtype.E4M3] PASSED [ 64%]
tests/test_fp8_native.py::test_quantization_formats[FP8Dtype.E5M2] PASSED [ 66%]
tests/test_fp8_native.py::test_layer_sizes[64-64] PASSED                 [ 67%]
tests/test_fp8_native.py::test_layer_sizes[256-128] PASSED               [ 69%]
tests/test_fp8_native.py::test_layer_sizes[512-512] PASSED               [ 70%]
tests/test_fp8_native.py::test_layer_sizes[1024-256] PASSED              [ 71%]
tests/test_fp8_training.py::TestFP8Config::test_config_creation PASSED   [ 73%]
tests/test_fp8_training.py::TestFP8Config::test_config_validation PASSED [ 74%]
tests/test_fp8_training.py::TestFP8LinearLayer::test_layer_creation PASSED [ 76%]
tests/test_fp8_training.py::TestFP8LinearLayer::test_forward_pass PASSED [ 77%]
tests/test_fp8_training.py::TestFP8LinearLayer::test_scale_updates PASSED [ 78%]
tests/test_fp8_training.py::TestFP8TrainingEngine::test_engine_creation FAILED [ 80%]
tests/test_fp8_training.py::TestFP8TrainingEngine::test_setup_fp8_training FAILED [ 81%]
tests/test_fp8_training.py::TestFP8TrainingEngine::test_training_step FAILED [ 83%]
tests/test_fp8_training.py::TestFP8TrainingEngine::test_optimizer_step FAILED [ 84%]
tests/test_fp8_training.py::TestFP8TrainingEngine::test_context_manager FAILED [ 85%]
tests/test_fp8_training.py::TestFP8ModelConversion::test_convert_model PASSED [ 87%]
tests/test_fp8_training.py::TestFP8ModelConversion::test_converted_model_forward PASSED [ 88%]
tests/test_fp8_training.py::TestFP8Validation::test_validate_fp8_setup PASSED [ 90%]
tests/test_fp8_training.py::TestFP8Integration::test_factory_function FAILED [ 91%]
tests/test_fp8_training.py::TestFP8Integration::test_end_to_end_training FAILED [ 92%]
tests/test_fp8_training.py::TestFP8Integration::test_statistics_tracking FAILED [ 94%]
tests/test_fp8_training.py::TestFP8Performance::test_memory_efficiency PASSED [ 95%]
tests/test_fp8_training.py::TestFP8Performance::test_numerical_stability PASSED [ 97%]
tests/test_fp8_training.py::test_different_format_combinations[format_combo0] FAILED [ 98%]
tests/test_fp8_training.py::test_different_format_combinations[format_combo1] FAILED [100%]

=================================== FAILURES ===================================
__________________ TestFP8TrainingEngine.test_engine_creation __________________
tests/test_fp8_training.py:180: in test_engine_creation
    engine = FP8TrainingEngine(simple_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
________________ TestFP8TrainingEngine.test_setup_fp8_training _________________
tests/test_fp8_training.py:188: in test_setup_fp8_training
    engine = FP8TrainingEngine(simple_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
___________________ TestFP8TrainingEngine.test_training_step ___________________
tests/test_fp8_training.py:200: in test_training_step
    engine = FP8TrainingEngine(simple_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
__________________ TestFP8TrainingEngine.test_optimizer_step ___________________
tests/test_fp8_training.py:214: in test_optimizer_step
    engine = FP8TrainingEngine(simple_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
__________________ TestFP8TrainingEngine.test_context_manager __________________
tests/test_fp8_training.py:245: in test_context_manager
    with FP8TrainingEngine(simple_model, fp8_config) as engine:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
___________________ TestFP8Integration.test_factory_function ___________________
tests/test_fp8_training.py:301: in test_factory_function
    trainer = create_fp8_trainer(simple_model)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:626: in create_fp8_trainer
    return FP8TrainingEngine(model, config, device)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
_________________ TestFP8Integration.test_end_to_end_training __________________
tests/test_fp8_training.py:318: in test_end_to_end_training
    engine = FP8TrainingEngine(fp8_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
----------------------------- Captured stdout call -----------------------------
Converted attention.out_proj to FP8LinearLayer
Converted ff1 to FP8LinearLayer
Converted ff2 to FP8LinearLayer
Converted output_proj to FP8LinearLayer
_________________ TestFP8Integration.test_statistics_tracking __________________
tests/test_fp8_training.py:349: in test_statistics_tracking
    engine = FP8TrainingEngine(simple_model, fp8_config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
______________ test_different_format_combinations[format_combo0] _______________
tests/test_fp8_training.py:423: in test_different_format_combinations
    engine = FP8TrainingEngine(simple_model, config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
______________ test_different_format_combinations[format_combo1] _______________
tests/test_fp8_training.py:423: in test_different_format_combinations
    engine = FP8TrainingEngine(simple_model, config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:284: in __init__
    self.fp8_recipe = config.to_te_recipe() if TRANSFORMER_ENGINE_AVAILABLE else None
                      ^^^^^^^^^^^^^^^^^^^^^
kernel_pytorch/precision/fp8_training_engine.py:110: in to_te_recipe
    return DelayedScaling(
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
E   scaling_factor_compute_algo
E     Input should be callable [type=callable_type, input_value='max', input_type=str]
E       For further information visit https://errors.pydantic.dev/2.9/v/callable_type
=========================== short test summary info ============================
FAILED tests/test_fp8_training.py::TestFP8TrainingEngine::test_engine_creation - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8TrainingEngine::test_setup_fp8_training - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8TrainingEngine::test_training_step - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8TrainingEngine::test_optimizer_step - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8TrainingEngine::test_context_manager - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8Integration::test_factory_function - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8Integration::test_end_to_end_training - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::TestFP8Integration::test_statistics_tracking - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::test_different_format_combinations[format_combo0] - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
FAILED tests/test_fp8_training.py::test_different_format_combinations[format_combo1] - pydantic_core._pydantic_core.ValidationError: 1 validation error for DelayedScaling
scaling_factor_compute_algo
  Input should be callable [type=callable_type, input_value='max', input_type=str]
    For further information visit https://errors.pydantic.dev/2.9/v/callable_type
================== 10 failed, 61 passed, 4 warnings in 11.40s ==================
